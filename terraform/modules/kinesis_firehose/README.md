Kinesis Firehose Terraform Module
===========

Terraform module for creating a Kinesis Firehose Stream(intended for streaming logs to Splunk), creating the lambda function that processes the logs(intended for conversion of Cloudwatch Logs to Splunk ingestable format) and a backup S3 bucket(intended to store logs that failed to be sent to splunk) along with creation of necessary IAM roles, Cloudwatch Logs, etc. for the respective resources


Module Input Variables
============
- `environment`: Terraform workspace value expected here
- `project`: Project name for which these resources are created
- `splunk_hec_endpoint`: Endpoint for kinesis to send logs to Splunk to(Provided by NMS team normally)
- `splunk_hec_token`: Authentication token needed to be allowed to send logs to Splunk Cloud(Provided by NMS team normally for the index)
- `aws_region`: Region in which the resources to be created(defaults to London i.e. `eu-west-2`)
- `kms_key_arn`: KMS Key used to encrypt cloudwatch logs generated by lambda and firehose stream(Optional, if not provided, it won't encrypt)
- `lambda_source_dir`: Source directory for lambda code
- `lambda_output_path`: Output path for lambda code to be picked up at function creation
- `lambda_handler`: Calling function name in lambda
- `lambda_memory`: Memory allocation for lambda, defaults to 128MB
- `lambda_env_vars`: Environment variables to be passed to function at runtime as a map(Optional, if not provided, environment variables won't be set for lambda)
- `common_tags`: Tags for resources


Usage
============
```hcl
module "kinesis_firehose" {
    source = "git::https://github.com/NHSDigital/spine-core-aws-common.git//terraform/modules/kinesis_firehose?ref=v0.0.8"
    environment = local.environment
    project = "gp-reg"
    splunk_hec_endpoint = local.splunk_hec_endpoint[terraform.workspace]
    splunk_hec_token = aws_ssm_parameter.firehose_splunk_hec_token.value
    kms_key_arn = aws_kms_key.cloudwatch_log_key.arn
    lambda_source_dir = "cw_logs_to_splunk/"
    lambda_output_path = ".lambda/cw_logs_to_splunk.zip"
    lambda_env_vars = {
      LAMBDA_INDEX_PREFIX  = "lambda"
      DEFAULT_INDEX_PREFIX = "cloudwatch"
      ENV                  = local.environment
    }
    lambda_memory = local.splunk_formatter_memory[terraform.workspace]
    common_tags = local.common_tags
}
```


Outputs
=============
- `splunk_kinesis_firehose_stream_arn`: ARN for the firehose stream